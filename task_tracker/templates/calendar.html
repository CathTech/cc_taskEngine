<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Календарь - Task Tracker</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/main.min.css' rel='stylesheet' />
    <style>
        body {
            padding-top: 20px;
            padding-bottom: 40px;
            background-color: #f5f5f5;
        }
        .header {
            margin-bottom: 30px;
        }
        .card {
            margin-bottom: 20px;
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
            border: 1px solid rgba(0, 0, 0, 0.125);
        }
        .btn-group {
            margin-bottom: 20px;
        }
        #calendar {
            background-color: white;
            border-radius: 0.375rem;
            padding: 10px;
        }
        .fc-event {
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Календарь задач</h1>
            <p class="lead">Просмотр задач по датам</p>
        </div>
        
        <div class="btn-group mb-4" role="group">
            <a href="{{ url_for('index') }}" class="btn btn-secondary">Главная</a>
            <a href="{{ url_for('projects') }}" class="btn btn-primary">Проекты</a>
            <a href="{{ url_for('kanban') }}" class="btn btn-warning">Kanban</a>
        </div>
        
        <div class="card">
            <div class="card-body">
                <div class="project-filters mb-3">
                    <button class="btn btn-outline-primary project-filter-btn active" data-project="all">Все</button>
                    <!-- Project filter buttons will be added here dynamically -->
                </div>
                <div id="calendar"></div>
            </div>
        </div>
    </div>

    <!-- Modal for task details -->
    <div class="modal fade" id="taskModal" tabindex="-1" aria-labelledby="taskModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="taskModalLabel">Детали задачи</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="taskDetailsContent"></div>
                </div>
                <div class="modal-footer">
                    <a href="#" class="btn btn-primary" id="openTaskBtn">Открыть задачу</a>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>
    <script>
        // Simple notification function
        function showNotification(message) {
            // Create notification element
            const notification = document.createElement('div');
            notification.style.position = 'fixed';
            notification.style.bottom = '20px';
            notification.style.right = '20px';
            notification.style.backgroundColor = '#28a745';
            notification.style.color = 'white';
            notification.style.padding = '15px 20px';
            notification.style.borderRadius = '5px';
            notification.style.zIndex = '9999';
            notification.style.boxShadow = '0 4px 6px rgba(0,0,0,0.1)';
            notification.style.opacity = '0';
            notification.style.transition = 'opacity 0.3s ease-in-out';
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            // Fade in
            setTimeout(() => {
                notification.style.opacity = '1';
            }, 10);
            
            // Remove after 3 seconds
            setTimeout(() => {
                notification.style.opacity = '0';
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 3000);
        }

        document.addEventListener('DOMContentLoaded', function() {
            var calendarEl = document.getElementById('calendar');
            
            var calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'timeGridWeek',
                locale: 'ru',
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek,timeGridDay'
                },
                events: {{ events | safe }},
                eventClick: function(info) {
                    // Handle click on calendar event
                    const taskId = info.event.extendedProps.taskId;
                    
                    // Show loading state
                    document.getElementById('taskDetailsContent').innerHTML = '<div class="text-center"><div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div></div>';
                    
                    // Fetch task details via API
                    fetch(`/api/tasks`)
                        .then(response => response.json())
                        .then(data => {
                            const task = data.find(t => t.id == taskId);
                            
                            if (task) {
                                // Format the task details
                                const taskDetails = `
                                    <div class="task-details">
                                        <h6>${task.project_identifier}-${task.id}: ${task.title}</h6>
                                        <p><strong>Проект:</strong> ${task.project_name}</p>
                                        <p><strong>Описание:</strong> ${task.description || '-'}</p>
                                        <p><strong>Запланировано:</strong> ${task.planned_date || '-'}</p>
                                        <p><strong>Дедлайн:</strong> ${task.deadline || '-'}</p>
                                        <p><strong>Приоритет:</strong> 
                                            <span class="badge ${
                                                task.priority === 'Срочный' ? 'bg-danger' :
                                                task.priority === 'Важный' ? 'bg-warning text-dark' :
                                                task.priority === 'Базовый' ? 'bg-primary' :
                                                task.priority === 'Низкий' ? 'bg-secondary' : 'bg-info'
                                            }">${task.priority}</span>
                                        </p>
                                        <p><strong>Статус:</strong> 
                                            ${task.completed ? 
                                                `<span class="badge bg-success">Выполнено (${task.completion_date})</span>` : 
                                                '<span class="badge bg-secondary">Не выполнено</span>'
                                            }
                                        </p>
                                        <p><strong>В календаре:</strong> ${task.show_in_calendar ? 'Да' : 'Нет'}</p>
                                    </div>
                                `;
                                
                                document.getElementById('taskDetailsContent').innerHTML = taskDetails;
                                document.getElementById('openTaskBtn').href = `/task/${task.id}`;
                            } else {
                                document.getElementById('taskDetailsContent').innerHTML = '<p>Ошибка: задача не найдена</p>';
                            }
                        })
                        .catch(error => {
                            console.error('Error fetching task details:', error);
                            document.getElementById('taskDetailsContent').innerHTML = '<p>Ошибка загрузки деталей задачи</p>';
                        });
                    
                    // Show the modal
                    var taskModal = new bootstrap.Modal(document.getElementById('taskModal'));
                    taskModal.show();
                },
                dateClick: function(info) {
                    // Handle click on empty date cell
                    if (confirm('Создать новую задачу на эту дату?')) {
                        fetch('/create_task_from_calendar', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                date: info.dateStr
                            })
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.redirect_url) {
                                window.location.href = data.redirect_url;
                            } else {
                                alert('Ошибка создания задачи: ' + (data.error || 'Неизвестная ошибка'));
                            }
                        })
                        .catch(error => {
                            console.error('Error creating task:', error);
                            alert('Ошибка при создании задачи');
                        });
                    }
                },
                eventDidMount: function(info) {
                    // Add tooltip to events
                    info.el.setAttribute('title', info.event.title);
                },
                // Enable event dragging within the calendar
                editable: true,
                eventDrop: function(info) {
                    // Handle moving an event to a new date/time
                    const taskId = info.event.extendedProps.taskId;
                    const newDate = info.event.start;
                    
                    // Format date as YYYY-MM-DD
                    const dateStr = newDate.toISOString().split('T')[0];
                    let timeStr = null;
                    
                    // Extract time if it's a timed event
                    if (info.event.start) {
                        timeStr = newDate.toTimeString().substring(0, 5); // HH:MM format
                    }
                    
                    // Update the task with the new planned date/time via API
                    fetch('/api/update_task_datetime', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            task_id: parseInt(taskId),
                            planned_date: dateStr,
                            planned_time: timeStr
                        })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            showNotification('Задача успешно перемещена');
                        } else {
                            console.error('Error updating task:', data.error);
                            showNotification('Ошибка при обновлении задачи: ' + data.error);
                            
                            // Revert the event to its original position
                            info.revert();
                        }
                    })
                    .catch(error => {
                        console.error('Error updating task datetime:', error);
                        showNotification('Ошибка при обновлении задачи');
                        
                        // Revert the event to its original position
                        info.revert();
                    });
                },
                // Enable external drag-and-drop
                droppable: true,
                eventReceive: function(info) {
                    // Handle when a task is dropped from outside the calendar
                    console.log('Event received:', info);
                    
                    // Extract the date from the event
                    const taskId = info.event.extendedProps.taskId;
                    const eventDate = info.event.start;
                    
                    // Format date as YYYY-MM-DD
                    const dateStr = eventDate.toISOString().split('T')[0];
                    
                    // Update the task with the new planned date via API
                    fetch('/api/update_task_datetime', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            task_id: parseInt(taskId),
                            planned_date: dateStr
                        })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            showNotification('Задача успешно добавлена в календарь');
                            
                            // Update the event in the calendar with the new task information
                            info.event.setProp('title', `[${data.task.project_identifier}-${data.task.id}] ${data.task.title}`);
                        } else {
                            console.error('Error updating task:', data.error);
                            showNotification('Ошибка при обновлении задачи: ' + data.error);
                        }
                    })
                    .catch(error => {
                        console.error('Error updating task datetime:', error);
                        showNotification('Ошибка при обновлении задачи');
                    });
                },
                // Add a custom drop handler for external elements
                drop: function(info) {
                    console.log('Drop on calendar:', info);
                    
                    // Get the task ID from the drag event
                    const taskId = info.draggedEl.getAttribute('data-task-id');
                    if (taskId) {
                        // Determine the date where the task was dropped
                        const dropDate = info.date.toISOString().split('T')[0];
                        
                        // Update the task with the new planned date via API
                        fetch('/api/update_task_datetime', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                task_id: parseInt(taskId),
                                planned_date: dropDate
                            })
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                showNotification('Задача успешно добавлена в календарь');
                                
                                // Add the task as a new event in the calendar
                                const newEvent = {
                                    id: data.task.id,
                                    title: `[${data.task.project_identifier}-${data.task.id}] ${data.task.title}`,
                                    start: dropDate,
                                    extendedProps: {
                                        taskId: data.task.id,
                                        projectId: data.task.project_id,
                                        description: data.task.description,
                                        priority: data.task.priority,
                                        completed: data.task.completed,
                                        color: data.task.color
                                    }
                                };
                                
                                calendar.addEvent(newEvent);
                            } else {
                                console.error('Error updating task:', data.error);
                                showNotification('Ошибка при обновлении задачи: ' + data.error);
                            }
                        })
                        .catch(error => {
                            console.error('Error updating task datetime:', error);
                            showNotification('Ошибка при обновлении задачи');
                        });
                    }
                }
            });
            
            // Initialize external drag functionality for tasks from kanban
            initExternalDrag(calendar);
            
            // Load projects and create filter buttons
            loadProjectsAndCreateFilters(calendar);
            
            calendar.render();
        });
        
        // Function to load projects and create filter buttons
        function loadProjectsAndCreateFilters(calendar) {
            fetch('/api/projects')
                .then(response => response.json())
                .then(projects => {
                    const filtersContainer = document.querySelector('.project-filters');
                    
                    // Clear existing project filter buttons (keep the 'All' button)
                    const allBtn = document.querySelector('[data-project="all"]');
                    filtersContainer.innerHTML = '';
                    filtersContainer.appendChild(allBtn);
                    
                    // Add a button for each project
                    projects.forEach(project => {
                        const btn = document.createElement('button');
                        btn.className = 'btn btn-outline-secondary project-filter-btn mx-1';
                        btn.setAttribute('data-project', project.id);
                        btn.textContent = project.name;
                        btn.addEventListener('click', function() {
                            // Toggle active state
                            document.querySelectorAll('.project-filter-btn').forEach(b => {
                                b.classList.remove('active');
                            });
                            this.classList.add('active');
                            
                            // Filter calendar events
                            filterCalendarByProject(calendar, project.id);
                        });
                        filtersContainer.appendChild(btn);
                    });
                    
                    // Add event listener for 'All' button
                    allBtn.addEventListener('click', function() {
                        // Toggle active state
                        document.querySelectorAll('.project-filter-btn').forEach(b => {
                            b.classList.remove('active');
                        });
                        this.classList.add('active');
                        
                        // Show all events
                        filterCalendarByProject(calendar, 'all');
                    });
                })
                .catch(error => {
                    console.error('Error loading projects:', error);
                });
        }
        
        // Function to filter calendar events by project
        function filterCalendarByProject(calendar, projectId) {
            const allEvents = calendar.getEvents();
            
            allEvents.forEach(event => {
                if (projectId === 'all') {
                    event.setProp('display', 'auto'); // Show all events
                } else {
                    const eventProjectId = event.extendedProps.projectId;
                    if (eventProjectId == projectId) {
                        event.setProp('display', 'auto'); // Show this event
                    } else {
                        event.setProp('display', 'none'); // Hide this event
                    }
                }
            });
        }
        
        // Function to handle external drag and drop
        function initExternalDrag(calendar) {
            // Wait for a short delay to allow other scripts to load
            setTimeout(function() {
                // Try to initialize drag from other sources like kanban
                setupExternalDragSources();
                
                // Also set up a MutationObserver to handle dynamically added elements
                const observer = new MutationObserver(function(mutations) {
                    mutations.forEach(function(mutation) {
                        mutation.addedNodes.forEach(function(node) {
                            if (node.nodeType === 1) { // Element node
                                if (node.classList && node.classList.contains('kanban-task')) {
                                    makeDraggable(node);
                                } else if (node.querySelectorAll) {
                                    const tasks = node.querySelectorAll('.kanban-task');
                                    tasks.forEach(makeDraggable);
                                }
                            }
                        });
                    });
                });
                
                observer.observe(document.body, {
                    childList: true,
                    subtree: true
                });
            }, 500);
            
            function setupExternalDragSources() {
                // Look for kanban tasks on the page (might be in an iframe or loaded separately)
                const kanbanTasks = document.querySelectorAll('.kanban-task');
                kanbanTasks.forEach(makeDraggable);
            }
            
            function makeDraggable(task) {
                if (task.hasAttribute('data-calendar-initialized')) return;
                
                task.setAttribute('data-calendar-initialized', 'true');
                task.setAttribute('draggable', 'true');
                
                task.addEventListener('dragstart', function(event) {
                    // Set the task ID as the data to transfer
                    event.dataTransfer.setData('text/plain', this.dataset.taskId);
                    event.dataTransfer.effectAllowed = 'move';
                    
                    // Add visual feedback
                    this.classList.add('dragging');
                });
                
                task.addEventListener('dragend', function() {
                    // Remove visual feedback
                    this.classList.remove('dragging');
                });
            }
        }
        
        // Helper function to show time indicator line
        function showTimeIndicator(clientY) {
            // Remove any existing indicator
            hideTimeIndicator();
            
            // Create a horizontal line element to show the time position
            const indicator = document.createElement('div');
            indicator.id = 'time-indicator';
            indicator.style.position = 'fixed';
            indicator.style.left = '0';
            indicator.style.width = '100%';
            indicator.style.height = '2px';
            indicator.style.backgroundColor = '#007bff';
            indicator.style.zIndex = '9998';
            indicator.style.top = clientY + 'px';
            indicator.style.pointerEvents = 'none';
            
            document.body.appendChild(indicator);
        }
        
        // Helper function to hide time indicator line
        function hideTimeIndicator() {
            const indicator = document.getElementById('time-indicator');
            if (indicator) {
                indicator.remove();
            }
        }
        
        // Helper function to calculate time from position
        function calculateTimeFromPosition(yPos, rect) {
            // This is a simplified calculation based on the height of the calendar
            // Time grid typically goes from 8am to 6pm (10 hours = 600 minutes)
            const calendarTopTime = 8; // Start at 8 AM
            const calendarTotalHours = 12; // Display 12 hours from 8am to 8pm (to cover full time grid)
            const calendarTotalMinutes = calendarTotalHours * 60;
            
            // Calculate the percentage of the way down the visible time portion
            // Assuming the time grid starts after the all-day slot area
            const timeGridTop = rect.height * 0.1; // Approximate offset for all-day area
            const timeGridHeight = rect.height * 0.9; // Remaining height for time slots
            
            // Calculate position within the time grid
            const relativeY = Math.max(0, yPos - timeGridTop);
            const percentDown = Math.min(1, relativeY / timeGridHeight);
            const totalMinutesFromTop = percentDown * calendarTotalMinutes;
            const hour = calendarTopTime + Math.floor(totalMinutesFromTop / 60);
            const minute = Math.round((totalMinutesFromTop % 60) / 5) * 5; // Round to nearest 5 minutes
            
            // Format as HH:MM
            const formattedHour = String(hour).padStart(2, '0');
            const formattedMinute = String(minute).padStart(2, '0');
            
            return `${formattedHour}:${formattedMinute}`;
        }
        
        // Helper function to get date from horizontal position
        function getDateFromPosition(clientX, calendar) {
            // This is a simplified approach - in a real implementation, 
            // we would need to calculate based on the current calendar view
            // For now, we'll return today's date as a fallback
            return new Date();
        }
    </script>
    
    <style>
        .drag-over-calendar {
            outline: 3px dashed #007bff;
            outline-offset: -3px;
        }
    </style>
    
    <!-- Fixed add button -->
    <div class="fixed-add-button" style="position: fixed; bottom: 30px; right: 30px; z-index: 1000;">
        <button onclick="createQuickTask()" class="btn btn-success btn-lg rounded-circle shadow-lg" style="width: 60px; height: 60px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem;" title="Быстрая задача">
            +
        </button>
    </div>
    
    <script>
        function createQuickTask() {
            fetch('{{ url_for('create_task_without_project') }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.redirect_url) {
                    window.location.href = data.redirect_url;
                } else {
                    // Fallback if JSON response is not as expected
                    window.location.reload();
                }
            })
            .catch(error => {
                console.error('Error:', error);
                // Fallback to regular navigation if fetch fails
                window.location.href = '{{ url_for('create_task_without_project') }}';
            });
        }
    </script>
</body>
</html>