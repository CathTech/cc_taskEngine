<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Календарь - Task Tracker</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/main.min.css' rel='stylesheet' />
    <style>
        body {
            padding-top: 20px;
            padding-bottom: 40px;
            background-color: #f5f5f5;
        }
        .header {
            margin-bottom: 30px;
        }
        .card {
            margin-bottom: 20px;
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
            border: 1px solid rgba(0, 0, 0, 0.125);
        }
        .btn-group {
            margin-bottom: 20px;
        }
        #calendar {
            background-color: white;
            border-radius: 0.375rem;
            padding: 10px;
        }
        .fc-event {
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Календарь задач</h1>
            <p class="lead">Просмотр задач по датам</p>
        </div>
        
        <div class="btn-group mb-4" role="group">
            <a href="{{ url_for('index') }}" class="btn btn-secondary">Главная</a>
            <a href="{{ url_for('projects') }}" class="btn btn-primary">Проекты</a>
            <a href="{{ url_for('kanban') }}" class="btn btn-warning">Kanban</a>
        </div>
        
        <div class="card">
            <div class="card-body">
                <div id="calendar"></div>
            </div>
        </div>
    </div>

    <!-- Modal for task details -->
    <div class="modal fade" id="taskModal" tabindex="-1" aria-labelledby="taskModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="taskModalLabel">Детали задачи</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="taskDetailsContent"></div>
                </div>
                <div class="modal-footer">
                    <a href="#" class="btn btn-primary" id="openTaskBtn">Открыть задачу</a>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            var calendarEl = document.getElementById('calendar');
            
            var calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                locale: 'ru',
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek,timeGridDay'
                },
                events: {{ events | safe }},
                eventClick: function(info) {
                    // Handle click on calendar event
                    const taskId = info.event.extendedProps.taskId;
                    
                    // Show loading state
                    document.getElementById('taskDetailsContent').innerHTML = '<div class="text-center"><div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div></div>';
                    
                    // Fetch task details via API
                    fetch(`/api/tasks`)
                        .then(response => response.json())
                        .then(data => {
                            const task = data.find(t => t.id == taskId);
                            
                            if (task) {
                                // Format the task details
                                const taskDetails = `
                                    <div class="task-details">
                                        <h6>${task.project_identifier}-${task.id}: ${task.title}</h6>
                                        <p><strong>Проект:</strong> ${task.project_name}</p>
                                        <p><strong>Описание:</strong> ${task.description || '-'}</p>
                                        <p><strong>Запланировано:</strong> ${task.planned_date || '-'}</p>
                                        <p><strong>Дедлайн:</strong> ${task.deadline || '-'}</p>
                                        <p><strong>Приоритет:</strong> 
                                            <span class="badge ${
                                                task.priority === 'Срочный' ? 'bg-danger' :
                                                task.priority === 'Важный' ? 'bg-warning text-dark' :
                                                task.priority === 'Базовый' ? 'bg-primary' :
                                                task.priority === 'Низкий' ? 'bg-secondary' : 'bg-info'
                                            }">${task.priority}</span>
                                        </p>
                                        <p><strong>Статус:</strong> 
                                            ${task.completed ? 
                                                `<span class="badge bg-success">Выполнено (${task.completion_date})</span>` : 
                                                '<span class="badge bg-secondary">Не выполнено</span>'
                                            }
                                        </p>
                                        <p><strong>В календаре:</strong> ${task.show_in_calendar ? 'Да' : 'Нет'}</p>
                                    </div>
                                `;
                                
                                document.getElementById('taskDetailsContent').innerHTML = taskDetails;
                                document.getElementById('openTaskBtn').href = `/task/${task.id}`;
                            } else {
                                document.getElementById('taskDetailsContent').innerHTML = '<p>Ошибка: задача не найдена</p>';
                            }
                        })
                        .catch(error => {
                            console.error('Error fetching task details:', error);
                            document.getElementById('taskDetailsContent').innerHTML = '<p>Ошибка загрузки деталей задачи</p>';
                        });
                    
                    // Show the modal
                    var taskModal = new bootstrap.Modal(document.getElementById('taskModal'));
                    taskModal.show();
                },
                dateClick: function(info) {
                    // Handle click on empty date cell
                    if (confirm('Создать новую задачу на эту дату?')) {
                        fetch('/create_task_from_calendar', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                date: info.dateStr
                            })
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.redirect_url) {
                                window.location.href = data.redirect_url;
                            } else {
                                alert('Ошибка создания задачи: ' + (data.error || 'Неизвестная ошибка'));
                            }
                        })
                        .catch(error => {
                            console.error('Error creating task:', error);
                            alert('Ошибка при создании задачи');
                        });
                    }
                },
                eventDidMount: function(info) {
                    // Add tooltip to events
                    info.el.setAttribute('title', info.event.title);
                }
            });
            
            calendar.render();
        });
    </script>
    
    <!-- Fixed add button -->
    <div class="fixed-add-button" style="position: fixed; bottom: 30px; right: 30px; z-index: 1000;">
        <a href="{{ url_for('create_task_without_project') }}" class="btn btn-success btn-lg rounded-circle shadow-lg" style="width: 60px; height: 60px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem;" title="Быстрая задача">
            +
        </a>
    </div>
</body>
</html>