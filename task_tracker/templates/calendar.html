<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Календарь - Task Tracker</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/main.min.css' rel='stylesheet' />
    <style>
        body {
            padding-top: 20px;
            padding-bottom: 40px;
            background-color: #f5f5f5;
        }
        .header {
            margin-bottom: 30px;
        }
        .card {
            margin-bottom: 20px;
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
            border: 1px solid rgba(0, 0, 0, 0.125);
        }
        .btn-group {
            margin-bottom: 20px;
        }
        #calendar {
            background-color: white;
            border-radius: 0.375rem;
            padding: 10px;
        }
        .fc-event {
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Календарь задач</h1>
            <p class="lead">Просмотр задач по датам</p>
        </div>
        
        <div class="btn-group mb-4" role="group">
            <a href="{{ url_for('index') }}" class="btn btn-secondary">Главная</a>
            <a href="{{ url_for('projects') }}" class="btn btn-primary">Проекты</a>
            <a href="{{ url_for('kanban') }}" class="btn btn-warning">Kanban</a>
        </div>
        
        <div class="card">
            <div class="card-body">
                <div id="calendar"></div>
            </div>
        </div>
    </div>

    <!-- Modal for task details -->
    <div class="modal fade" id="taskModal" tabindex="-1" aria-labelledby="taskModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="taskModalLabel">Детали задачи</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="taskDetailsContent"></div>
                </div>
                <div class="modal-footer">
                    <a href="#" class="btn btn-primary" id="openTaskBtn">Открыть задачу</a>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>
    <script>
        // Simple notification function
        function showNotification(message) {
            // Create notification element
            const notification = document.createElement('div');
            notification.style.position = 'fixed';
            notification.style.bottom = '20px';
            notification.style.right = '20px';
            notification.style.backgroundColor = '#28a745';
            notification.style.color = 'white';
            notification.style.padding = '15px 20px';
            notification.style.borderRadius = '5px';
            notification.style.zIndex = '9999';
            notification.style.boxShadow = '0 4px 6px rgba(0,0,0,0.1)';
            notification.style.opacity = '0';
            notification.style.transition = 'opacity 0.3s ease-in-out';
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            // Fade in
            setTimeout(() => {
                notification.style.opacity = '1';
            }, 10);
            
            // Remove after 3 seconds
            setTimeout(() => {
                notification.style.opacity = '0';
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 3000);
        }

        document.addEventListener('DOMContentLoaded', function() {
            var calendarEl = document.getElementById('calendar');
            
            var calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'timeGridWeek',
                locale: 'ru',
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek,timeGridDay'
                },
                events: {{ events | safe }},
                eventClick: function(info) {
                    // Handle click on calendar event
                    const taskId = info.event.extendedProps.taskId;
                    
                    // Show loading state
                    document.getElementById('taskDetailsContent').innerHTML = '<div class="text-center"><div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div></div>';
                    
                    // Fetch task details via API
                    fetch(`/api/tasks`)
                        .then(response => response.json())
                        .then(data => {
                            const task = data.find(t => t.id == taskId);
                            
                            if (task) {
                                // Format the task details
                                const taskDetails = `
                                    <div class="task-details">
                                        <h6>${task.project_identifier}-${task.id}: ${task.title}</h6>
                                        <p><strong>Проект:</strong> ${task.project_name}</p>
                                        <p><strong>Описание:</strong> ${task.description || '-'}</p>
                                        <p><strong>Запланировано:</strong> ${task.planned_date || '-'}</p>
                                        <p><strong>Дедлайн:</strong> ${task.deadline || '-'}</p>
                                        <p><strong>Приоритет:</strong> 
                                            <span class="badge ${
                                                task.priority === 'Срочный' ? 'bg-danger' :
                                                task.priority === 'Важный' ? 'bg-warning text-dark' :
                                                task.priority === 'Базовый' ? 'bg-primary' :
                                                task.priority === 'Низкий' ? 'bg-secondary' : 'bg-info'
                                            }">${task.priority}</span>
                                        </p>
                                        <p><strong>Статус:</strong> 
                                            ${task.completed ? 
                                                `<span class="badge bg-success">Выполнено (${task.completion_date})</span>` : 
                                                '<span class="badge bg-secondary">Не выполнено</span>'
                                            }
                                        </p>
                                        <p><strong>В календаре:</strong> ${task.show_in_calendar ? 'Да' : 'Нет'}</p>
                                    </div>
                                `;
                                
                                document.getElementById('taskDetailsContent').innerHTML = taskDetails;
                                document.getElementById('openTaskBtn').href = `/task/${task.id}`;
                            } else {
                                document.getElementById('taskDetailsContent').innerHTML = '<p>Ошибка: задача не найдена</p>';
                            }
                        })
                        .catch(error => {
                            console.error('Error fetching task details:', error);
                            document.getElementById('taskDetailsContent').innerHTML = '<p>Ошибка загрузки деталей задачи</p>';
                        });
                    
                    // Show the modal
                    var taskModal = new bootstrap.Modal(document.getElementById('taskModal'));
                    taskModal.show();
                },
                dateClick: function(info) {
                    // Handle click on empty date cell
                    if (confirm('Создать новую задачу на эту дату?')) {
                        fetch('/create_task_from_calendar', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                date: info.dateStr
                            })
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.redirect_url) {
                                window.location.href = data.redirect_url;
                            } else {
                                alert('Ошибка создания задачи: ' + (data.error || 'Неизвестная ошибка'));
                            }
                        })
                        .catch(error => {
                            console.error('Error creating task:', error);
                            alert('Ошибка при создании задачи');
                        });
                    }
                },
                eventDidMount: function(info) {
                    // Add tooltip to events
                    info.el.setAttribute('title', info.event.title);
                },
                // Enable external drag-and-drop
                droppable: true,
                eventReceive: function(info) {
                    // Handle when a task is dropped from outside the calendar
                    console.log('Event received:', info);
                    
                    // Open edit task modal with the selected date/time
                    const taskId = info.event.extendedProps.taskId; // This will be the task ID
                    const eventDate = info.event.start;
                    
                    // Redirect to edit task page with the new date
                    window.location.href = `/edit_task/${taskId}`;
                },
                // Add a custom drop handler for external elements
                drop: function(info) {
                    console.log('Drop on calendar:', info);
                }
            });
            
            calendar.render();
            
            // Make calendar accept external draggables
            // We need to initialize the external drag functionality
            initExternalDrag(calendar);
        });
        
        // Function to handle external drag and drop
        function initExternalDrag(calendar) {
            // This will handle the drop of tasks from kanban to calendar
            const calendarEl = document.getElementById('calendar');
            
            // Add dragover listener to highlight drop area
            calendarEl.addEventListener('dragover', function(e) {
                e.preventDefault(); // Necessary to allow drop
                this.classList.add('drag-over-calendar');
                
                // Create and show a time indicator line on the calendar
                showTimeIndicator(e.clientY);
            });
            
            calendarEl.addEventListener('dragleave', function(e) {
                this.classList.remove('drag-over-calendar');
                
                // Remove the time indicator line
                hideTimeIndicator();
            });
            
            calendarEl.addEventListener('drop', function(e) {
                e.preventDefault();
                this.classList.remove('drag-over-calendar');
                
                // Remove the time indicator line
                hideTimeIndicator();
                
                // Get the task ID from the dragged element
                const taskId = e.dataTransfer.getData('text/plain');
                
                if (taskId) {
                    // Determine the date and time where the task was dropped
                    // Calculate the date based on the calendar view and position
                    const rect = this.getBoundingClientRect();
                    const y = e.clientY - rect.top;
                    
                    // Calculate the time based on the vertical position
                    const time = calculateTimeFromPosition(y, rect);
                    
                    // Determine the date by finding which date column the drop occurred in
                    // This is complex with FullCalendar, so we'll use the current view's start date
                    // as a reference and estimate the date based on horizontal position
                    const date = getDateFromPosition(e.clientX, calendar);
                    
                    if (date && time) {
                        const dateString = date.toISOString().split('T')[0];
                        
                        // Update the task's planned date and time via API
                        fetch('/api/update_task_datetime', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                task_id: parseInt(taskId),
                                planned_date: dateString,
                                planned_time: time
                            })
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                // Show a temporary notification
                                showNotification(`Задача запланирована на ${dateString} ${time}`);
                                
                                // Reload the calendar to reflect the changes
                                setTimeout(() => {
                                    location.reload();
                                }, 1000); // Delay to allow user to see the notification
                            } else {
                                console.error('Error updating task:', data.error);
                                alert('Ошибка обновления задачи: ' + (data.error || 'Неизвестная ошибка'));
                            }
                        })
                        .catch(error => {
                            console.error('Error updating task:', error);
                            alert('Ошибка соединения при обновлении задачи');
                        });
                    } else {
                        // Fallback to current date if we can't determine the date from position
                        const today = new Date();
                        const dateString = today.toISOString().split('T')[0];
                        const time = '12:00'; // Default to noon
                        
                        // Update the task's planned date and time via API
                        fetch('/api/update_task_datetime', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                task_id: parseInt(taskId),
                                planned_date: dateString,
                                planned_time: time
                            })
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                // Show a temporary notification
                                showNotification(`Задача запланирована на ${dateString} ${time}`);
                                
                                // Reload the calendar to reflect the changes
                                setTimeout(() => {
                                    location.reload();
                                }, 1000); // Delay to allow user to see the notification
                            } else {
                                console.error('Error updating task:', data.error);
                                alert('Ошибка обновления задачи: ' + (data.error || 'Неизвестная ошибка'));
                            }
                        })
                        .catch(error => {
                            console.error('Error updating task:', error);
                            alert('Ошибка соединения при обновлении задачи');
                        });
                    }
                }
            });
        }
        
        // Helper function to show time indicator line
        function showTimeIndicator(clientY) {
            // Remove any existing indicator
            hideTimeIndicator();
            
            // Create a horizontal line element to show the time position
            const indicator = document.createElement('div');
            indicator.id = 'time-indicator';
            indicator.style.position = 'fixed';
            indicator.style.left = '0';
            indicator.style.width = '100%';
            indicator.style.height = '2px';
            indicator.style.backgroundColor = '#007bff';
            indicator.style.zIndex = '9998';
            indicator.style.top = clientY + 'px';
            indicator.style.pointerEvents = 'none';
            
            document.body.appendChild(indicator);
        }
        
        // Helper function to hide time indicator line
        function hideTimeIndicator() {
            const indicator = document.getElementById('time-indicator');
            if (indicator) {
                indicator.remove();
            }
        }
        
        // Helper function to calculate time from position
        function calculateTimeFromPosition(yPos, rect) {
            // This is a simplified calculation based on the height of the calendar
            // Time grid typically goes from 8am to 6pm (10 hours = 600 minutes)
            const calendarTopTime = 8; // Start at 8 AM
            const calendarTotalHours = 12; // Display 12 hours from 8am to 8pm (to cover full time grid)
            const calendarTotalMinutes = calendarTotalHours * 60;
            
            // Calculate the percentage of the way down the visible time portion
            // Assuming the time grid starts after the all-day slot area
            const timeGridTop = rect.height * 0.1; // Approximate offset for all-day area
            const timeGridHeight = rect.height * 0.9; // Remaining height for time slots
            
            // Calculate position within the time grid
            const relativeY = Math.max(0, yPos - timeGridTop);
            const percentDown = Math.min(1, relativeY / timeGridHeight);
            const totalMinutesFromTop = percentDown * calendarTotalMinutes;
            const hour = calendarTopTime + Math.floor(totalMinutesFromTop / 60);
            const minute = Math.round((totalMinutesFromTop % 60) / 5) * 5; // Round to nearest 5 minutes
            
            // Format as HH:MM
            const formattedHour = String(hour).padStart(2, '0');
            const formattedMinute = String(minute).padStart(2, '0');
            
            return `${formattedHour}:${formattedMinute}`;
        }
        
        // Helper function to get date from horizontal position
        function getDateFromPosition(clientX, calendar) {
            // This is a simplified approach - in a real implementation, 
            // we would need to calculate based on the current calendar view
            // For now, we'll return today's date as a fallback
            return new Date();
        }
    </script>
    
    <style>
        .drag-over-calendar {
            outline: 3px dashed #007bff;
            outline-offset: -3px;
        }
    </style>
    
    <!-- Fixed add button -->
    <div class="fixed-add-button" style="position: fixed; bottom: 30px; right: 30px; z-index: 1000;">
        <button onclick="createQuickTask()" class="btn btn-success btn-lg rounded-circle shadow-lg" style="width: 60px; height: 60px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem;" title="Быстрая задача">
            +
        </button>
    </div>
    
    <script>
        function createQuickTask() {
            fetch('{{ url_for('create_task_without_project') }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.redirect_url) {
                    window.location.href = data.redirect_url;
                } else {
                    // Fallback if JSON response is not as expected
                    window.location.reload();
                }
            })
            .catch(error => {
                console.error('Error:', error);
                // Fallback to regular navigation if fetch fails
                window.location.href = '{{ url_for('create_task_without_project') }}';
            });
        }
    </script>
</body>
</html>